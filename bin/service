#!/bin/sh


# IP-address of the server with application
addr='0.0.0.0'

# Port on the application server
port=56780

# Path to the directory with the application
path=/home/gribanov/projects/application


if [ ! -f ${path}/app/router.php ] || [ ! -f ${path}/app/console ];
then
    echo "Cent run Application" >&2
    exit 1
fi


stop_server() {
    if [ -f ${path}/bin/.spid ]
    then
        kill `cat ${path}/bin/.spid` 2> /dev/null
        rm ${path}/bin/.spid
    fi
}
stop_task_manager() {
    if [ -f ${path}/bin/.tmpid ]
    then
        kill `cat ${path}/bin/.tmpid` 2> /dev/null
        rm ${path}/bin/.tmpid
    fi
}
stop_cron() {
    if [ -f ${path}/bin/.cpid ]
    then
        kill `cat ${path}/bin/.cpid` 2> /dev/null
        rm ${path}/bin/.cpid
    fi
}


case "$1" in
    stop)
        stop_server
        stop_task_manager
        stop_cron
        ;;
    start|reload|restart|force-reload)
        stop_server
        stop_task_manager
        stop_cron

        # run server
        php -S ${addr}:${port} -t ${path}/web ${path}/app/router.php > /dev/null 2> /dev/null &
        echo $! > ${path}/bin/.spid
        # run task manager
        ${path}/app/console animedb:task-manager > /dev/null 2> /dev/null &
        echo $! > ${path}/bin/.tmpid
        # run cron
        ${path}/app/console animedb:cron > /dev/null 2> /dev/null &
        echo $! > ${path}/bin/.cpid
        ;;
    *)
        echo "Usage: $N {start|stop|restart}" >&2
        exit 1
        ;;
esac

exit 0
